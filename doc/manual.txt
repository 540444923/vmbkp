-------------------------------------------------------------------------------
Manual of Vmbkp.
Version r20101014

-------------------------------------------------------------------------------
Contents
-------------------------------------------------------------------------------
* What is vmbkp?
* Required environment
* Required tool and library
* How to build
* Easy installation
* Command-line interface
* Easy usage
* Log
* Parallel execution
* Configuration files
* Archive management
* Backup behavior
* Other reminders

-------------------------------------------------------------------------------
What is vmbkp?
-------------------------------------------------------------------------------

Vmbkp is an online backup tool for VMware vSphere.

* Online backup
* Multi-generation management
* Fast archive access
* Command-line Interface

-------------------------------------------------------------------------------
Required environment
-------------------------------------------------------------------------------

* Linux kernel 2.6.18 on amd64 host. CentOS 5.5 amd64 is better.
  Virtual machine may work well but the backup host must not be managed by
  target vCenter/ESXi in order to use SAN transfer.

* VMware vSphere 4.
  I confirmed it worked well with vCenter of essential license.
  It does not work with free ESXi due to failure of taking snapshot.

* SAN environment (for SAN transfer).
  Shared VMFS storage managed by vSphere via iscsi protocol are supported.
  It works well where VMFS storages are available as /dev/sdX devices.
  I confirmed it with open iscsi initiator.
  Read priviledge to the devices are required to backup via SAN.
  It's enough to add your backup user to disk group.

-------------------------------------------------------------------------------
Required tool and library
-------------------------------------------------------------------------------

* For Java code, see vmbkp/README file.
* For C++ code, see vmdkbkp/README file.

-------------------------------------------------------------------------------
How to build
-------------------------------------------------------------------------------

* For Java code, see vmbkp/README file.
* For C++ code, see vmdkbkp/README file.

-------------------------------------------------------------------------------
Easy installation
-------------------------------------------------------------------------------

To install Java and C++ executables,

> tar xzfv vmbkp-VERSION.tar.gz
> cd vmbkp-VERSION
> make
> ./install.sh /path/to/backup/directory

After installation, just do the following steps:

> cd /path/to/bacukp/directory
> ./vmbkp --help

To configure vSphere authentication information,
edit vsphere section of 'vmbkp_global.conf' in the backup directory.

-------------------------------------------------------------------------------
Command-line interface
-------------------------------------------------------------------------------

./vmbkp [COMMAND] [OPTION(s)] [TARGET(s)]

COMMAND is one of
update, backup, restore, status, check, destroy, clean, and list.
See message of --help command.

TARGET string should be [a-zA-Z0-9-_]+ (regexp).
If space characters are included in the vm name,
you should enclose the string in double quates.
Special target 'all' means all virtual machines in the vSphere.

You can specify one of the followings as a target:
* Virtual machine moref (unique in vSphere).
* Virtual machine name.
* Group name. (See 'vmbkp_group.conf').

-------------------------------------------------------------------------------
Easy usage
-------------------------------------------------------------------------------
Backup all virtual machines:
  > ./vmbkp update; ./vmbkp backup all

Backup the virtual machine that name is VM_NAME:
  > ./vmbkp update; ./vmbkp backup VM_NAME

Restore the latest generation of ARCHIVED_VM as NEW_VM_NAME:
  > ./vmbkp restore --name NEW_VM_NAME ARCHIVED_VM 

Show status of archives:
  > ./vmbkp status --detail all

Clean garbages such as files generated by failed backup execution:
  > ./vmbkp clean

Delete archive of the specified virtual machine.
  > ./vmbkp clean --all ARCHIVED_VM

Check the latest generation of the archive is valid.
  > ./vmbk pcheck ARCHIVED_VM


-------------------------------------------------------------------------------
Log
-------------------------------------------------------------------------------

* Log by Java executables will be appended to 'vmbkp.log'
  of working directory.

* Log by C++ executables in backup will be put into
  the target archive generation directory.

* Log by C++ executables in restore will be put into
  the archive generation directory to be restored.

-------------------------------------------------------------------------------
Parallel execution
-------------------------------------------------------------------------------

Parallel execution are supported with several exceptions.

* Any other commands wait during update command execution.

* Parallel backup of the different virtual machines may work but
  SCSI reservation conflicts may occur.
  Due to VDDK limitation, you should avoid parallel backup of
  virtual machines aside on the same storage volume.

* Status command skip virtual machines under backup or restore.

* Concurrent backup(s), restore(s), check(s) of the same virtual machine
  are serialized.

-------------------------------------------------------------------------------
Configuration files
-------------------------------------------------------------------------------

* Global configuration file.

  You can specify it with --conf option.
  Default is vmbkp_global.conf
  Sample file is available at sourcetree/vmbkp/conf/vmbkp_global.conf.

* Group configuration file.

  You can specify it with --grpconf option.
  Default is vmbkp_group.conf
  Sample file is available at sourcetree/vmbkp/conf/vmbkp_group.conf.

-------------------------------------------------------------------------------
Archive management
-------------------------------------------------------------------------------

Using install.sh scripts,
archives will be stored in 'archives' directory in the backup directory.

* archives/vmbkp_allvm.profile

  * The name, moref, and other information of all virtual machines
    in the vSphere environment are stored.
  * This is used to select TARGET(s).
  * Use 'update' command to update it after create/delete/modify
    virtual machines in the vSphere environment.

* archives/<vm-moref>/

  * Archives of each virtual machine identified by <vm-moref> are stored.
  * Moref is used due to its uniqueness.
  * vmbkp_vm.profile contains management information of each generations.
    Do not edit it by yourself if you know what you are doing.

* archives/<vm-moref>/<generation-id>/

  * Each archive generation of each virtual machine is stored.
  * vmbkp_generation.profile contains information of each generation.
  * <snapshot-moref>.ovf is ovf information file without disks.
  * Archive file for each vmdk.
    <disk-id> is only unique in the generation, not unique
    in the several generations.
    * <disk-id>.dump(.gz):   Full image of vmdk.
    * <disk-id>.digest(.gz): Checksum of each blocks.
    * <disk-id>.rdiff(.gz):  Reverse-diff of vmdk. (diff/incr mode only)
    * <disk-id>.bmp:         Changed block bitmap. (incr mode only)
    * <disk-id>.log:         Log of vmdkbkp command.


Causion.

* Each archive directory can manage one vCenter/ESX(i) environment.

* For several vCenter/ESX(i) management,
  prepare archive directory and global configuration file for each.
  
-------------------------------------------------------------------------------
Backup behavior
-------------------------------------------------------------------------------

* There are three mode:
  * full full backup.
  * diff: differential backup.
  * incr: incremental backup.

Backup mode is automatically determined.

'incr' is selected when
  * Full image of previous succeeded backup is available.
  * Virtual machine supports incremental backup
    by setting 'ctkEnabled' parameter true.

'diff' is selected when
  * Full image of previous succeeded backup is available.
  * ctkEnabled is false.

'full' is selected when
  * Full image of previous succeeded backup is not available.


'incr' executes
  * Get changed block information from vSphere using VI-Java
    and save it as <disk-id>.bmp file.
  * Get only changed blocks of the target vmdk using VDDK and
    read the corresponding dump file of the previous generation,
    then save <disk-id>.dump, <disk-id>.digest, and <disk-id>.rdiff files.

'diff' executes
  * Get all blocks of the target vmdk using VDDK and
    read the corresponding dump file of the previous generation,
    then save <disk-id>.dump, <disk-id>.digest, and <disk-id>.rdiff files.

'full' executes
  * Get all blocks of the target vmdk using VDDK then
    save <disk-id>.dump and <disk-id>.digest files.

-------------------------------------------------------------------------------
Other reminders
-------------------------------------------------------------------------------

* Character encoding.
  * You should use ASCII code only.
  * Configuration and profile file management code
    does not take care non-ASCII code indeedly.
  * UTF-8 code may work with the correct locale setting.
    such as ja_JP.UTF-8 for Japanese.

* Template.
  * Currently virtual machine template is not supported.
  * Each moref is marked as template or virtual machine internally
    and just skip ones marked as template.

* Folder structure in the vSphere inventory.
  * Currently default folder will be selected.

* SAN transfer for restore is not supported well.
  * Explicit allocation method is not supported by VDDK.
  * For thin vmdk, write to non-allocated blocks failed.
  * For thick vmdk, write to non-allocated blocks implicitly
    allocate them but its speed is too slow cause it talks with vSphere
    by soap protocol to allocate blocks one by one.

* Independent disk.
  * Currently independent vmdk disk is not supported.
    because VDDK access to the indepenent vmdk through snapshot failed.
  * Independent vmdk disks are just skipped in backup.

-------------------------------------------------------------------------------
